clear; 
clc;

msg_t_x = [3.581, 3.63645, 3.68575, 3.63701, 3.6052, 3.64906, 3.56039, 3.50567, 3.4194, 3.41444, 3.39168, 3.36011, 3.30125, 3.28168, 3.29318, 3.1296, 3.1962, 3.19884, 0, 0, 0, 0, 0, 3.39666, 3.31617, 3.2763, 3.26712, 3.10872, 3.17243, 3.20461, 3.03455, 2.97523, 3.00379, 3.02089, 3.05003, 3.15865, 3.12766, 3.07794, 3.07797, 3.04719, 3.00596, 2.95318, 2.87374, 2.80767, 2.84355, 2.74711, 2.71195, 2.69935, 2.6966, 2.64523, 2.60907, 2.58965, 0, 0, 2.1989, 2.11478, 2.1624, 2.09087, 2.20711, 0, 1.9585, 0, 0, 1.59895, 0, 0, 0, 0, 0, 0, 0, 0, 1.23298, 1.18586, 0, 1.06608, 0, 0, 0, 0, 0.522507, 0.461638, 0.406107, 0.350374, 0.293202, 0.246476, 0.193225, 0.141464, 0.0939494, 0.0459696, 1.6049e-16, -0.0451668, -0.0897266, -0.132724, -0.175368, -0.216321, -0.255886, -0.291511, -0.330536, -0.369498, -0.402343, -0.457942, -0.497533, -0.524586, -0.555453, -0.588037, -0.617152, -0.652866, -0.687872, -0, -0, -0.785542, -0.81402, -0.839681, -0.872857, -0.903558, -0.939868, -0.967, -0.993871, -1.01374, -1.06, -1.0821, -1.11813, -1.14864, -1.17039, -1.20279, -1.22201, -1.25358, -1.27688, -1.32975, -1.35628, -1.36067, -0, -0, -0, -0, -0, -0, -3.06399, -3.04223, -3.10171, -3.03165, -3.07245, -0, -3.09125, -0, -0, -0, -0, -0, -0, -0, -1.92924, -1.85686, -0, -0, -2.19525, -2.13557, -2.11769, -0, -1.86905, -1.85227, -1.86502, -1.76821, -1.71585, -1.72031, -1.71257, -1.67104, -1.6384, -1.62263, -1.58849, -1.5645, -1.5666, -1.55532, -1.49874, -1.4913, -1.45744, -1.457, -1.42813, -1.42278, -1.395, -1.36879, -1.34618, -1.34815, -1.3118, -1.30302, -1.28194, -1.25557, -1.24774, -1.23264, -1.23495, -1.20053, -1.18943, -1.18873, -1.17891, -1.14172, -1.12948, -1.13131, -1.0823, -1.1072, -1.08065, -1.07829, -1.06719, -1.03741, -1.00399, -1.03138, -1.00305, -0.979216, -0.984487, -0.972577, -0.956092, -0.95317, -0.917588, -0.887313, -0.913599, -0.822429, -0.682001, -0.43925, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0.431354, -0.448598, -0.408, -0.43245, -0.416891, -0.401328, -0.383136, -0.382047, -0.334338, -0.340327, -0.333774, -0.298879, -0.285245, -0.275756, -0.255557, -0.242084, -0.24201, -0.227761, -0.212891, -0, -0, -0, -0, -0.114041, -0.150446, -0, -0, -0, -0.0774297, -0.05265, -0.0311304, -0.0155675, -1.7341e-16, 0.0126879, 0, 0.0533303, 0.0729653, 0, 0, 0, 0, 0.119047, 0.158193, 0.169057, 0.17818, 0.192108, 0.20394, 0.216373, 0.227401, 0.249393, 0.376074, 0.402077, 0.399822, 0.44796, 0, 0, 0.586921, 0.810582, 0.839481, 0.86122, 0.349287, 0.360698, 0.363, 0.33632, 0.341268, 0.334408, 0.334957, 0.328659, 0.317404, 0.31174, 0.314603, 0.318436, 0.314966, 0.318189, 0.319175, 0.321221, 0.320932, 0.320319, 0.325861, 0.332035, 0.338131, 0.341129, 0.345486, 0.352047, 0.358545, 0.365775, 0.368912, 0.374352, 0.381357, 0.539265, 0.535118, 0.494586, 0.459859, 0.461799, 0.463547, 0.465996, 0.469171, 0.406932, 0.416577, 0.426194, 0.436704, 0.446251, 0.45763, 0.517199, 0.547809, 0.575695, 0.575796, 0.580521, 0.58897, 0, 2.24289, 2.15565, 2.18529, 2.2144, 2.28455, 2.31958, 2.35006, 2.39386, 2.4151, 2.42467, 2.48249, 2.44963];
msg_t_y = [0.0634744, 0.0634744, 0.128709, 0.190608, 0.2521, 0.319252, 0.374212, 0.430443, 0.480565, 0.540794, 0.598044, 0.653139, 0.701702, 0.757635, 0.821083, 0.838574, 0.916494, 0.977983, 0, 0, 0, 0, 0, 1.4418, 1.47645, 1.52777, 1.59348, 1.58397, 1.68681, 1.77634, 1.752, 1.7877, 1.87697, 1.96179, 2.05727, 2.21171, 2.27238, 2.3194, 2.40477, 2.46757, 2.5223, 2.56716, 2.58753, 2.61819, 2.74598, 2.74711, 2.8083, 2.8947, 2.99487, 3.04299, 3.10937, 3.19796, 0, 0, 3.02653, 3.02021, 3.20589, 3.21966, 3.53212, 0, 3.39222, 0, 0, 3.13812, 0, 0, 0, 0, 0, 0, 0, 0, 3.79472, 3.87877, 0, 3.97865, 0, 0, 0, 0, 2.96329, 2.91467, 2.8896, 2.85357, 2.78963, 2.81724, 2.76325, 2.6993, 2.69036, 2.6336, 2.621, 2.58761, 2.56943, 2.53252, 2.50788, 2.47256, 2.43459, 2.37417, 2.35189, 2.33292, 2.2818, 2.35591, 2.34071, 2.27223, 2.2278, 2.19458, 2.15227, 2.13543, 2.11705, 0, 0, 2.04641, 2.01477, 1.97816, 1.96047, 1.93769, 1.92701, 1.89784, 1.8692, 1.82883, 1.83597, 1.80091, 1.78938, 1.76876, 1.73518, 1.71776, 1.68195, 1.66356, 1.63433, 1.64211, 1.61635, 1.56527, 0, 0, 0, 0, 0, 0, 2.75883, 2.64457, 2.60265, 2.45498, 2.40046, 0, 2.24593, 0, 0, 0, 0, 0, 0, 0, 1.0258, 0.946116, 0, 0, 0.977388, 0.906496, 0.855601, 0, 0.680278, 0.637788, 0.605982, 0.540595, 0.492013, 0.460957, 0.426992, 0.385791, 0.348252, 0.315407, 0.280095, 0.247792, 0.220172, 0.190969, 0.157524, 0.130472, 0.101914, 0.0763582, 0.0498714, 0.0248348, 1.70838e-16, -0.0238923, -0.0470096, -0.0706535, -0.0917298, -0.114, -0.134737, -0.154165, -0.175358, -0.19523, -0.217755, -0.233359, -0.252821, -0.27444, -0.293935, -0.305924, -0.323874, -0.345876, -0.351661, -0.38124, -0.393323, -0.413915, -0.431172, -0.440354, -0.447004, -0.48094, -0.489222, -0.498936, -0.523461, -0.539108, -0.552, -0.572722, -0.573373, -0.576228, -0.616231, -0.575871, -0.495503, -0.330998, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0.690311, -0.746593, -0.706677, -0.780161, -0.784057, -0.78765, -0.785546, -0.819302, -0.750934, -0.80176, -0.826121, -0.778606, -0.783704, -0.800854, -0.786524, -0.79182, -0.843988, -0.850015, -0.85386, -0, -0, -0, -0, -0.720025, -1.07048, -0, -0, -0, -1.1073, -1.00462, -0.891457, -0.891864, -0.944, -0.726889, -0, -1.0176, -1.04345, -0, -0, -0, -0, -0.751631, -0.89716, -0.869722, -0.838273, -0.832112, -0.817959, -0.807514, -0.793041, -0.815728, -1.15744, -1.16772, -1.0985, -1.16698, -0, -0, -1.31825, -1.7383, -1.72119, -1.69024, -0.656913, -0.650717, -0.628734, -0.55973, -0.546143, -0.514944, -0.496593, -0.469374, -0.436869, -0.413693, -0.402673, -0.393236, -0.375362, -0.366034, -0.35448, -0.344468, -0.332335, -0.320319, -0.31468, -0.309627, -0.304454, -0.296539, -0.289897, -0.285082, -0.280126, -0.275631, -0.26803, -0.262124, -0.257229, -0.350203, -0.334379, -0.297177, -0.2655, -0.255979, -0.246473, -0.237437, -0.22883, -0.189756, -0.185472, -0.180909, -0.17644, -0.1713, -0.166564, -0.178086, -0.177994, -0.176008, -0.165107, -0.15555, -0.146847, -0, -0.476741, -0.419017, -0.385325, -0.350726, -0.321072, -0.284809, -0.247001, -0.209435, -0.16888, -0.127072, -0.0866904, -0.0427584];

msg_t_minus_1_x = [2.451, 2.41563, 2.47349, 2.69031, 2.65651, 2.70865, 2.79759, 2.84166, 2.84306, 2.90874, 2.88253, 3.11274, 3.09486, 3.30701, 3.32132, 3.21557, 3.35096, 3.43026, 3.52747, 3.48045, 3.38853, 3.34222, 3.29336, 3.27608, 3.21111, 3.14036, 3.02714, 3.06595, 2.99672, 2.96146, 2.88386, 2.87151, 2.72902, 0, 0, 2.96042, 0, 0, 0, 0, 0, 0, 2.52298, 2.48514, 2.44144, 2.40982, 2.34447, 2.31402, 2.27973, 2.27784, 0, 2.19696, 2.38138, 2.29111, 2.21066, 2.22548, 2.12941, 2.10884, 2.02588, 2.0653, 1.9405, 1.85973, 1.82155, 1.78963, 1.71096, 1.66765, 1.59441, 1.53206, 1.52352, 0, 0, 1.19418, 1.17426, 1.11364, 1.05156, 0.974971, 0, 0.898454, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.137818, 0, 2.44317e-16, -0.069862, -0.142495, -0.213478, -0, -0, -0, -0, -0.417241, -0.460699, -0.501496, -0.545905, -0.58943, -0.623114, -0.667463, -0.703988, -0.735952, -0.773031, -0.814569, -0.853314, -0.87523, -0.907029, -0.950752, -0.971748, -1.00342, -1.01513, -1.04639, -1.07233, -1.0934, -1.13058, -1.175, -1.20519, -1.23895, -1.23088, -1.25427, -1.27334, -1.2896, -1.32098, -1.34584, -0, -0, -0, -0, -1.45334, -1.4692, -1.50402, -1.51205, -1.53584, -1.55986, -1.57055, -1.57116, -1.6118, -1.63433, -1.66276, -1.68195, -1.70138, -1.70616, -1.74276, -1.76055, -1.77862, -1.77189, -1.8367, -1.83123, -0, -0, -0, -0, -0, -3.87656, -3.84168, -3.75501, -3.69981, -0, -3.69229, -3.63741, -3.67631, -0, -0, -0, -0, -0, -0, -0, -2.1171, -2.13623, -0, -2.48194, -0, -2.36456, -2.26066, -2.249, -2.11868, -2.09472, -1.97928, -1.95922, -1.83001, -1.78517, -1.75879, -1.75376, -1.70673, -1.66925, -1.64913, -1.61394, -1.57361, -1.55635, -1.54065, -1.49284, -1.46123, -1.41517, -1.40126, -1.37383, -1.35089, -1.32402, -1.28134, -1.26343, -1.25433, -1.22685, -1.19751, -1.17785, -1.13963, -1.13796, -1.10232, -1.07787, -1.05672, -1.03961, -1.02394, -0.994282, -0.988711, -0.965313, -0.951227, -0.936872, -0.926029, -0.901435, -0.859341, -0.845224, -0.820244, -0.799552, -0.793846, -0.768831, -0.75578, -0.751419, -0.718055, -0.703085, -0.692689, -0.644213, -0.587916, -0.573173, -0.577862, -0, -0, -0.2555, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, 0.0150789, 0.0300485, 0.0420258, 0.0600603, 0.0697246, 0.0846681, 0.100055, 0.113287, 0.12327, 0, 0.124598, 0, 0, 0.153137, 0.163832, 0, 0, 0.285841, 0.264361, 0.27772, 0.274868, 0.287323, 0.307505, 0.319288, 0.333446, 0.34719, 0.360014, 0.39999, 0.4213, 0.443, 0.453234, 0.454671, 0.4673, 0.481465, 0.466891, 0.507846, 0.521172, 0.534394, 0.544362, 0.554726, 0.556338, 0.679168, 0.643806, 0.907919, 1.39654, 0, 0.585083, 0.575194, 0.53207, 0.494099, 0.488825, 0.472806, 0.471195, 0.448195, 0.431693, 0.432758, 0.421851, 0.41724, 0.413155, 0.407898, 0.408447, 0.412337, 0.414318, 0.415243, 0.413276, 0.416577, 0.420671, 0.426505, 0.432248, 0.437897, 0.439666, 0.44129, 0.471458, 0.634433, 0.62592, 0.570534, 0.521288, 0.518418, 0.518299, 0.518009, 0.443472, 0.451562, 0.459549, 0.467425, 0.473192, 0.479828, 0.48833, 0.498696, 0.503923];
msg_t_minus_1_y = [.042165, 0.042165, 0.0863762, 0.140993, 0.185761, 0.236976, 0.294039, 0.348912, 0.399566, 0.460699, 0.508268, 0.605055, 0.657833, 0.763484, 0.828099, 0.861609, 0.960872, 1.04874, 1.14614, 1.19842, 1.23332, 1.28296, 1.3306, 1.39061, 1.42968, 1.46437, 1.47643, 1.56218, 1.59339, 1.64157, 1.665, 1.72538, 1.70528, 0, 0, 2.07291, 0, 0, 0, 0, 0, 0, 2.2717, 2.31743, 2.35767, 2.40982, 2.42777, 2.48148, 2.53189, 2.62035, 0, 2.71302, 3.04803, 3.04041, 3.04271, 3.17831, 3.15698, 3.24733, 3.24209, 3.43724, 3.36104, 3.35504, 3.42584, 3.51235, 3.50799, 3.57629, 3.5811, 3.6093, 3.77086, 0, 0, 3.46816, 3.61401, 3.64256, 3.66721, 3.63864, 0, 3.89163, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3.94659, 0, 3.99, 4.00239, 4.08051, 4.07341, 0, 0, 0, 0, 2.96882, 2.90874, 2.84412, 2.80844, 2.77305, 2.69901, 2.67705, 2.62732, 2.56657, 2.52847, 2.50698, 2.4782, 2.40467, 2.36289, 2.35319, 2.2893, 2.25372, 2.17695, 2.14542, 2.10456, 2.05639, 2.03961, 2.03516, 2.00577, 1.98274, 1.8954, 1.85953, 1.81852, 1.77498, 1.753, 1.72259, 0, 0, 0, 0, 1.55851, 1.5214, 1.50402, 1.46017, 1.4322, 1.40451, 1.36526, 1.31836, 1.30521, 1.27688, 1.25298, 1.22201, 1.19132, 1.15082, 1.13176, 1.10011, 1.0687, 1.023, 1.0181, 0.973684, 0, 0, 0, 0, 0, 1.56623, 1.47468, 1.36671, 1.27395, 0, 1.12885, 1.04301, 0.985065, 0, 0, 0, 0, 0, 0, 0, 0.259947, 0.224527, 0, 0.173554, 0, 0.0825722, 0.0394599, 2.75423e-16, -0.0369816, -0.0731493, -0.10373, -0.137002, -0.160105, -0.187629, -0.215952, -0.246476, -0.270319, -0.294334, -0.320559, -0.343054, -0.363296, -0.388043, -0.412816, -0.428065, -0.446744, -0.459817, -0.482492, -0.500033, -0.518558, -0.534938, -0.543898, -0.562517, -0.584904, -0.598377, -0.610163, -0.626275, -0.631707, -0.657, -0.662339, -0.673527, -0.686245, -0.701228, -0.716971, -0.722388, -0.745047, -0.754185, -0.770288, -0.786129, -0.804984, -0.811655, -0.801348, -0.816224, -0.820244, -0.82796, -0.851296, -0.853873, -0.869425, -0.895506, -0.886724, -0.899908, -0.91923, -0.886683, -0.839631, -0.849764, -0.889829, -0, -0, -0.442539, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0, -0.863868, -0.860475, -0.801899, -0.858903, -0.796956, -0.805563, -0.81488, -0.806078, -0.778298, -0, -0.641003, -0, -0, -0.614197, -0.611431, -0, -0, -0.879727, -0.767761, -0.76303, -0.716056, -0.71115, -0.724437, -0.717133, -0.715077, -0.711845, -0.706568, -0.752271, -0.760045, -0.767298, -0.754307, -0.727625, -0.719579, -0.713801, -0.66679, -0.698991, -0.691618, -0.683993, -0.672231, -0.661096, -0.639994, -0.754292, -0.690398, -0.940177, -1.39654, -0, -0.545599, -0.517907, -0.462522, -0.414598, -0.395843, -0.369397, -0.355071, -0.325633, -0.302275, -0.291899, -0.273953, -0.26072, -0.248248, -0.2355, -0.226406, -0.219243, -0.211106, -0.202527, -0.192714, -0.185472, -0.178564, -0.172319, -0.165924, -0.159381, -0.151389, -0.143384, -0.144139, -0.181921, -0.167715, -0.14225, -0.120349, -0.110193, -0.100747, -0.0913389, -0.0702391, -0.0634629, -0.0564255, -0.0491284, -0.041399, -0.0335529, -0.0255923, -0.0174148, -0.00879601];

% have to remove all values == 0, as that means there is no laser data for
% that point, need to note this in c++ implementation too
msg_t_x(msg_t_x==0) = [];
msg_t_y(msg_t_y==0) = [];
msg_t_minus_1_x(msg_t_minus_1_x==0) =[];
msg_t_minus_1_y(msg_t_minus_1_y==0) =[];

plot(msg_t_x,msg_t_y,'.r')
hold on
plot(msg_t_minus_1_x,msg_t_minus_1_y,'.b')


size_t_minus_1 = length(msg_t_minus_1_x)
size_t = length(msg_t_x)

%calculate centroid for each msg:
centroid_t_x = 0;
centroid_t_y = 0;
for i = 1:size_t
  if (msg_t_x(i) > 0.01 || msg_t_x(i) < -.01 && msg_t_y(i) > 0.01 || msg_t_y(i) < -.01)
    centroid_t_x = centroid_t_x + msg_t_x(i);
    centroid_t_y = centroid_t_y + msg_t_y(i);
  end;
end;

centroid_t_x  = centroid_t_x / size_t
centroid_t_y  = centroid_t_y / size_t

centroid_t_minus_1_x = 0;
centroid_t_minus_1_y = 0;
for j = 1:size_t_minus_1
  if (msg_t_minus_1_x(j) > 0.01 || msg_t_minus_1_x(j) < -.01 && msg_t_minus_1_y(j) > 0.01 || msg_t_minus_1_y(j) < -.01)
    centroid_t_minus_1_x = centroid_t_minus_1_x + msg_t_minus_1_x(j);
    centroid_t_minus_1_y = centroid_t_minus_1_y + msg_t_minus_1_y(j);
  end;
end;

centroid_t_minus_1_x = centroid_t_minus_1_x / size_t_minus_1;
centroid_t_minus_1_y = centroid_t_minus_1_y / size_t_minus_1;
plot(centroid_t_x, centroid_t_y, 'xr')
plot(centroid_t_minus_1_x, centroid_t_minus_1_y, 'xb')

%Variance Vector generation

for i = 1:size_t
  if (msg_t_x(i) > 0.001 || msg_t_x(i) < -.01 && msg_t_y(i) > 0.001 || msg_t_y(i) < -.01)
    prime_t_x(i) = msg_t_x(i) - centroid_t_x;
    prime_t_y(i) = msg_t_y(i) - centroid_t_y;
  end;
end;

for j = 1:size_t_minus_1
  if (msg_t_minus_1_x(j) > 0.01 || msg_t_minus_1_x(j) < -.001 && msg_t_minus_1_y(j) > 0.01 || msg_t_minus_1_y(j) < -.01)
    prime_t_minus_1_x(j) = msg_t_minus_1_x(j) - centroid_t_minus_1_x;
    prime_t_minus_1_y(j) = msg_t_minus_1_y(j) - centroid_t_minus_1_y;
  end;
end;

centroid_t_x
centroid_t_y
centroid_t_minus_1_x
centroid_t_minus_1_y

% make kd tree
t_points = [msg_t_x(:) , msg_t_y(:)];
t_minus_1_points = [msg_t_minus_1_x(:) , msg_t_minus_1_y(:)];

size_t_p = size(t_points)

[Idx, Dist] = knnsearch(t_points, t_minus_1_points);
for i = 1:size_t_minus_1
    index = Idx(i)
    plot( [msg_t_minus_1_x(i), msg_t_x(index)], [msg_t_minus_1_y(i), msg_t_y(index)] )
end
hold off

if (size_t > size_t_minus_1)
    multiplication_iterations = size_t_minus_1
else
    mutliplication_iterations = size_t
end

prime_t = [prime_t_x(:), prime_t_y(:)]
prime_t_minus_1 = [prime_t_minus_1_x(:), prime_t_minus_1_y(:)]
w = zeros(2,2)

for i=1:multiplication_iterations
    w_loop = prime_t(i,:) .* prime_t_minus_1(i,:).';
    w = w + w_loop;
end
w

[U, S, V] = svd(w)
centroid_t_x
centroid_t = [centroid_t_x; centroid_t_y]
centroid_t_minus_1 = [centroid_t_minus_1_x; centroid_t_minus_1_y]
R = U * V
T = centroid_t - R * centroid_t_minus_1
Trans = zeros(3,3);
Trans(1,1) = R(1,1);
Trans(1,2) = R(1,2);
Trans(2,1) = R(2,1);
Trans(2,2) = R(2,2);
Trans(1,3) = T(1,1);
Trans(2,3) = T(2,1);
Trans(3,1) = 0;
Trans(3,2) = 0;
Trans(3,3) = 1;
Trans

msg_t_minus_1 = [msg_t_minus_1_x(:), msg_t_minus_1_y(:), 1]
for j = 1:size_t_minus_1
    trans_msg(j) = Trans * msg_t_minus_1(j);
end

trans_msg
        
    

